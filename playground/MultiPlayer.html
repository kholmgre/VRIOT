<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Chat example</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/0.5.0/aframe.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.slim.js"></script>
	<script>
		var socket = io.connect('http://localhost:3000', { reconnection: false });

		window.addEventListener("load", function () {
			var nickname = prompt('Name: ');

			socket.emit('register', nickname);

			let cameraEntityWrapper = document.createElement('a-entity');
			cameraEntityWrapper.setAttribute('position', '0 0 0');
			cameraEntityWrapper.setAttribute('id', 'player');

			let cameraElement = document.createElement('a-camera');
			cameraElement.setAttribute('rotation', '45');
			cameraElement.setAttribute('camera', '');
			cameraElement.setAttribute('look-controls', '');
			cameraElement.setAttribute('wasd-controls', '');

			cameraElement.addEventListener('componentchanged', function (evt) {
				if (evt.detail.name === 'position') {
					socket.emit('movement', { id: nickname, pos: evt.detail.newData });
				}
			});

			setInterval(() => {
				let playerElement = document.getElementById('player');
				var playerPos = playerElement.getAttribute('position');
				socket.emit('movement', { id: nickname, pos: playerPos });
			}, 1000);

			cameraEntityWrapper.appendChild(cameraElement);

			let scene = document.getElementById("scene");

			scene.appendChild(cameraEntityWrapper);

			socket.on('broadcast', function (data) {
				console.log(data);
			});

			socket.on('newPlayer', function (data) {
				if (data === nickname)
					return;
				let playerElement = document.createElement('a-sphere');
				playerElement.setAttribute('id', data);
				playerElement.setAttribute('rotation', '45');
				playerElement.setAttribute('position', '0 0 0');
				playerElement.setAttribute('color', 'red');

				let playerName = document.createElement('a-text');
				playerName.setAttribute('value', data);
				playerName.setAttribute('color', 'red');
				playerName.setAttribute('position', '-0.46 0.23 1.83');
				playerName.setAttribute('rotation', '-14.78 0 0');
				playerName.setAttribute('side', 'double');
				playerName.setAttribute('transparent', 'false');

				playerElement.appendChild(playerName);

				let scene = document.getElementById('scene');
				scene.appendChild(playerElement);
			});

			socket.on('playerMoved', function (data) {
				if (data.id === nickname)
					return;
				var playerElement = document.getElementById(data.id);

				if (playerElement === null) {
					let playerElement = document.createElement('a-sphere');
					playerElement.setAttribute('id', data.id);
					playerElement.setAttribute('rotation', '45');
					playerElement.setAttribute('position', '0 0 0');
					playerElement.setAttribute('color', 'red');

					let playerName = document.createElement('a-text');
					playerName.setAttribute('value', data.id);
					playerName.setAttribute('color', "red");
					playerName.setAttribute('position', '-0.46 0.23 1.83');
					playerName.setAttribute('rotation', '-14.78 0 0');
					playerName.setAttribute('side', 'double');
					playerName.setAttribute('transparent', 'false');

					playerElement.appendChild(playerName);

					let scene = document.getElementById('scene');
					scene.appendChild(playerElement);
				} else {
					playerElement.setAttribute('position', data.pos);
				}
			});
		});
	</script>
</head>

<body>
	<a-scene id="scene">
		<a-sky src="#space"></a-sky>
		<a-plane color="gray" scale="49 10 47" position="0 -10 0" rotation="-90 0 90"></a-plane>
	</a-scene>
</body>

</html>