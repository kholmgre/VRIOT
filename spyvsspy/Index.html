<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <title>Spy vs Spy</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/0.5.0/aframe.min.js"></script>
    <script>
        AFRAME.registerComponent('open-door', {
            init: function () {
                this.el.addEventListener('click', function (evt) {

                    let entity = document.querySelector('[sound]');

                    entity.components.sound.playSound();

                    setTimeout(() => {
                        let target = document.getElementById(this.getAttribute('target'));
                        let targetPos = target.getAttribute('position');

                        let newPos = { x: targetPos.x, y: targetPos.y, z: targetPos.z };

                        let playerElement = document.getElementById('player');
                        playerElement.setAttribute('position', newPos);
                    }, 1200);
                });
            }
        });

        AFRAME.registerComponent('room-factory', {
            init: () => {

            }
        });

        AFRAME.registerComponent('open-inventory-listener', {
            init: function () {
                this.el.addEventListener('click', function (evt) {
                    let inventoryElement = document.createElement('a-plane');
                    inventoryElement.setAttribute('position', '0 2.6 0');
                    inventoryElement.setAttribute('rotation', '90 0 -90');
                    inventoryElement.setAttribute('id', 'inventory');

                    let exitElement = document.createElement('a-plane');
                    exitElement.setAttribute('value', 'X');
                    exitElement.setAttribute('position', '0 0.4 0.05');
                    exitElement.setAttribute('rotation', '0 0 -90');
                    exitElement.setAttribute('scale', '0.2 0.2 1');
                    exitElement.setAttribute('color', 'green');
                    exitElement.setAttribute('close-inventory-listener', '');

                    inventoryElement.appendChild(exitElement);

                    let playerElement = document.getElementById('player');
                    playerElement.appendChild(inventoryElement);
                });
            }
        });

        AFRAME.registerComponent('close-inventory-listener', {
            init: function () {
                this.el.addEventListener('click', function (evt) {
                    console.log('close inventory');
                    let inventoryElement = document.getElementById('inventory');

                    inventoryElement.parentNode.removeChild(inventoryElement);
                });
            }
        });

        AFRAME.registerComponent('game-timer', {
            tick: function (time, timeDelta) {
                this.el.setAttribute('value', new Date().toLocaleTimeString());
            }
        });
    </script>
</head>

<body>
    <a-scene id="scene">
        <a-assets>
            <audio id="door" src="door.mp3"></audio>
            <image id="spy" src="spy.jpeg">
                </audio>
        </a-assets>
        <a-sky color="gray"></a-sky>
        <a-entity motion-tracker id="player" position="0 0 0">
            <a-camera look-controls wasd-controls position="0 1.83 0">
                <a-entity id="opendoor" sound="src: #door"></a-entity>
                <a-text game-timer color="black" position="-2.6 -1.2 -1.5" scale="0.2 0.2 0.2"></a-text>
                <!--<a-image src="#spy" position="0 0 -2"></a-image>-->
                <a-entity cursor="fuse: true; fuseTimeout: 500" position="0 0 -1" geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                    material="color: black; shader: flat">
                </a-entity>
            </a-camera>
        </a-entity>
    </a-scene>
    <script>
        (() => {

            let template = {
                options: {
                    time: '180'
                },
                rooms: [
                    { "Id": "1", "Directions": { "N": "2" }, "Colors": { "Floor": "#F5EBCD", "Wall": "#FFD79F" } }
                    ,
                    { "Id": "2", "Directions": { "S": "1", "W": "3" }, "Colors": { "Floor": "#BCC9E5", "Wall": "#A0B8FF" } }
                    ,
                    { "Id": "3", "Directions": { "E": "2" }, "Colors": { "Floor": "#DC9BBD", "Wall": "#FA74B3" } }
                ]
            }
            function CreateRooms(template) {

                function getPosition(direction) {

                    let position = { x: '0', y: '3.5', z: '0' }

                    switch (direction) {
                        case 'N':
                            position.x = "5";
                            break;
                        case 'S':
                            position.x = "-5";
                            break;
                        case 'E':
                            position.z = '-5';
                            break;
                        case 'W':
                            position.z = '5';
                            break;
                    }

                    return position.x + ' ' + position.y + ' ' + position.z;
                }

                function getRotation(direction) {
                    let rotation = { x: '0', y: '0', z: '0' }

                    switch (direction) {
                        case 'N':
                            rotation.y = "90";
                            break;
                        case 'S':
                            rotation.y = "90";
                            break;
                    }

                    return rotation.x + ' ' + rotation.y + ' ' + rotation.z;
                }

                function createWall(direction, color) {
                    let wall = document.createElement('a-plane');

                    wall.setAttribute('color', color);
                    wall.setAttribute('position', getPosition(direction));
                    wall.setAttribute('rotation', getRotation(direction));
                    wall.setAttribute('height', '4');
                    wall.setAttribute('width', '10');
                    wall.setAttribute('side', 'double');

                    return wall;
                }

                function createConnectingWall(targetRoomId, direction, color) {

                    let wall = document.createElement('a-entity');
                    wall.setAttribute('position', getPosition(direction));

                    let door = document.createElement('a-plane');
                    door.setAttribute('color', '#000000');
                    door.setAttribute('open-door', '');
                    door.setAttribute('target', targetRoomId);
                    door.setAttribute('position', '0 0 0');
                    door.setAttribute('rotation', getRotation(direction));
                    door.setAttribute('height', '4');
                    door.setAttribute('width', '2');
                    door.setAttribute('side', 'double');

                    let wall1 = document.createElement('a-plane');
                    wall1.setAttribute('color', color);

                    // TODO: refactor

                    if (direction === 'N' || direction === 'S')
                        wall1.setAttribute('position', '0 0 3');

                    if (direction === 'W' || direction === 'E')
                        wall1.setAttribute('position', '3 0 0');

                    wall1.setAttribute('rotation', getRotation(direction));
                    wall1.setAttribute('height', '4');
                    wall1.setAttribute('width', '4');
                    wall1.setAttribute('side', 'double');

                    let wall2 = document.createElement('a-plane');
                    wall2.setAttribute('color', color);
                    if (direction === 'N' || direction === 'S')
                        wall2.setAttribute('position', '0 0 -3');

                    if (direction === 'W' || direction === 'E')
                        wall2.setAttribute('position', '-3 0 0');

                    wall2.setAttribute('rotation', getRotation(direction));
                    wall2.setAttribute('height', '4');
                    wall2.setAttribute('width', '4');
                    wall2.setAttribute('side', 'double');

                    wall.appendChild(door);
                    wall.appendChild(wall1);
                    wall.appendChild(wall2);

                    return wall;
                }

                let rooms = template.rooms.map((room) => {

                    let roomElement = document.createElement('a-entity');
                    roomElement.setAttribute('id', room.Id);

                    let floor = document.createElement('a-plane');
                    floor.setAttribute('color', room.Colors.Floor);
                    floor.setAttribute('width', '10');
                    floor.setAttribute('height', '10');
                    floor.setAttribute('position', '0 1.5 0');
                    floor.setAttribute('rotation', '-90 0 90');
                    floor.setAttribute('side', 'double');

                    let roof = document.createElement('a-plane');
                    roof.setAttribute('color', room.Colors.Floor);
                    roof.setAttribute('width', '10');
                    roof.setAttribute('height', '10');
                    roof.setAttribute('position', '0 5.5 0');
                    roof.setAttribute('rotation', '-90 0 90');
                    roof.setAttribute('side', 'double');

                    roomElement.appendChild(floor);
                    roomElement.appendChild(roof);

                    let createdWalls = { "N": null, "S": null, "W": null, "E": null };

                    // Create connecting rooms
                    for (let direction in room.Directions) {
                        let wall = createConnectingWall(room.Directions[direction], direction, room.Colors.Wall);
                        createdWalls[direction] = wall;
                        roomElement.appendChild(wall);
                    }

                    for (let dir in createdWalls) {
                        if (createdWalls[dir] === null) {
                            let wall = createWall(dir, room.Colors.Wall);
                            createdWalls[dir] = wall;
                            roomElement.appendChild(wall);
                        }
                    }

                    return roomElement;
                });

                rooms.forEach((room, index, array) => {
                    let pos = '0 ' + index * 5 + ' 0';
                    room.setAttribute('position', pos);
                });

                return rooms;
            }

            let scene = document.getElementById('scene');

            let rooms = CreateRooms(template);

            rooms.forEach((room) => {
                scene.appendChild(room);
            });
        })();
    </script>
</body>

</html>