<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <title>Spy vs Spy</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aframe/0.5.0/aframe.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.slim.js"></script>
    <script>
        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min)) + min;
        }

        let playerName = 'offa' + getRandomInt(0, 10);

        var socket = io.connect('http://localhost:3000', { reconnection: false });

        window.addEventListener("load", function () {

            socket.emit('join', playerName);

            socket.on('joined', function (state) {

                function CreateRooms(template) {

                    function getPosition(direction) {

                        let position = { x: '0', y: '3.5', z: '0' }

                        switch (direction) {
                            case 'N':
                                position.x = "5";
                                break;
                            case 'S':
                                position.x = "-5";
                                break;
                            case 'E':
                                position.z = '-5';
                                break;
                            case 'W':
                                position.z = '5';
                                break;
                        }

                        return position.x + ' ' + position.y + ' ' + position.z;
                    }

                    function getDoorknobPosition(direction) {
                        let position = { x: '0.6', y: '0', z: '0' }

                        switch (direction) {
                            case 'N':
                                position.z = "-0.01";
                                break;
                            case 'S':
                                position.z = "0.01";
                                break;
                            case 'E':
                                position.z = '0.01';
                                break;
                            case 'W':
                                position.z = '-0.01';
                                break;
                        }

                        return position.x + ' ' + position.y + ' ' + position.z;
                    }

                    function getRotation(direction) {
                        let rotation = { x: '0', y: '0', z: '0' }

                        switch (direction) {
                            case 'N':
                                rotation.y = "90";
                                break;
                            case 'S':
                                rotation.y = "90";
                                break;
                        }

                        return rotation.x + ' ' + rotation.y + ' ' + rotation.z;
                    }

                    function createWall(direction, color) {
                        let wall = document.createElement('a-plane');

                        wall.setAttribute('color', color);
                        wall.setAttribute('position', getPosition(direction));
                        wall.setAttribute('rotation', getRotation(direction));
                        wall.setAttribute('height', '4');
                        wall.setAttribute('width', '10');
                        wall.setAttribute('side', 'double');

                        return wall;
                    }

                    function createConnectingWall(currentRoomId, targetRoomId, direction, color) {

                        let wall = document.createElement('a-entity');
                        wall.setAttribute('position', getPosition(direction));

                        let door = document.createElement('a-plane');
                        door.setAttribute('color', '#FF7562');
                        door.setAttribute('position', '0 0 0');
                        door.setAttribute('rotation', getRotation(direction));
                        door.setAttribute('height', '4');
                        door.setAttribute('width', '2');
                        door.setAttribute('side', 'double');

                        let doorKnob = document.createElement('a-circle');
                        doorKnob.setAttribute('color', '#000000');
                        doorKnob.setAttribute('id', targetRoomId + currentRoomId);
                        doorKnob.setAttribute('open-door', '');
                        doorKnob.setAttribute('target', targetRoomId);
                        doorKnob.setAttribute('position', getDoorknobPosition(direction));
                        doorKnob.setAttribute('height', '1');
                        doorKnob.setAttribute('width', '1');
                        doorKnob.setAttribute('radius', '0.05');
                        doorKnob.setAttribute('side', 'double');

                        door.appendChild(doorKnob);

                        let wall1 = document.createElement('a-plane');
                        wall1.setAttribute('color', color);

                        // TODO: refactor

                        if (direction === 'N' || direction === 'S')
                            wall1.setAttribute('position', '0 0 3');

                        if (direction === 'W' || direction === 'E')
                            wall1.setAttribute('position', '3 0 0');

                        wall1.setAttribute('rotation', getRotation(direction));
                        wall1.setAttribute('height', '4');
                        wall1.setAttribute('width', '4');
                        wall1.setAttribute('side', 'double');

                        let wall2 = document.createElement('a-plane');
                        wall2.setAttribute('color', color);
                        if (direction === 'N' || direction === 'S')
                            wall2.setAttribute('position', '0 0 -3');

                        if (direction === 'W' || direction === 'E')
                            wall2.setAttribute('position', '-3 0 0');

                        wall2.setAttribute('rotation', getRotation(direction));
                        wall2.setAttribute('height', '4');
                        wall2.setAttribute('width', '4');
                        wall2.setAttribute('side', 'double');

                        wall.appendChild(door);
                        wall.appendChild(wall1);
                        wall.appendChild(wall2);

                        return wall;
                    }

                    let rooms = template.rooms.map((room) => {

                        let roomElement = document.createElement('a-entity');
                        roomElement.setAttribute('id', room.Id);

                        let floor = document.createElement('a-plane');
                        floor.setAttribute('color', room.Colors.Floor);
                        floor.setAttribute('width', '10');
                        floor.setAttribute('height', '10');
                        floor.setAttribute('position', '0 1.5 0');
                        floor.setAttribute('rotation', '-90 0 90');
                        floor.setAttribute('side', 'double');

                        let roof = document.createElement('a-plane');
                        roof.setAttribute('color', room.Colors.Floor);
                        roof.setAttribute('width', '10');
                        roof.setAttribute('height', '10');
                        roof.setAttribute('position', '0 5.5 0');
                        roof.setAttribute('rotation', '-90 0 90');
                        roof.setAttribute('side', 'double');

                        roomElement.appendChild(floor);
                        roomElement.appendChild(roof);

                        let createdWalls = { "N": null, "S": null, "W": null, "E": null };

                        // Create connecting rooms
                        for (let direction in room.Directions) {
                            let wall = createConnectingWall(room.Id, room.Directions[direction], direction, room.Colors.Wall);
                            createdWalls[direction] = wall;
                            roomElement.appendChild(wall);
                        }

                        for (let dir in createdWalls) {
                            if (createdWalls[dir] === null) {
                                let wall = createWall(dir, room.Colors.Wall);
                                createdWalls[dir] = wall;
                                roomElement.appendChild(wall);
                            }
                        }

                        return roomElement;
                    });

                    rooms.forEach((room, index, array) => {
                        let pos = '0 ' + index * 5 + ' 0';
                        room.setAttribute('position', pos);
                    });

                    return rooms;
                }

                let scene = document.getElementById('scene');

                if (state.playerData.Name !== playerName) {
                    // store somewhere? react on disconnect and other states?

                    let enemyElement = document.createElement('a-entity');
                    enemyElement.setAttribute('id', state.playerData.Name);

                    let enemyAvatar = document.createElement('a-image');
                    enemyAvatar.setAttribute('src', 'spy.jpeg');
                    enemyAvatar.setAttribute('side', 'double');
                    enemyAvatar.setAttribute('visible', 'true');
                    enemyAvatar.setAttribute('position', '0 0 -2');

                    enemyElement.appendChild(enemyAvatar);
                    let roomElement = document.getElementById(state.playerData.Room);
                    enemyElement.setAttribute('position', roomElement.getAttribute('position'));

                    scene.appendChild(enemyElement);
                } else {
                    let rooms = CreateRooms(state.template);

                    rooms.forEach((room) => {
                        if (room.getAttribute("id") === state.players[playerName].Room) {
                            let playerElement = document.getElementById('player');
                            playerElement.setAttribute('currentroom', room.id);

                            let roomPos = room.components.position.attrValue;

                            playerElement.setAttribute('position', roomPos);
                        }

                        scene.appendChild(room);
                    });
                }
            });

            socket.on('player-moved', function (state) {

                console.log(state);

                if (state.player === playerName) {
                    let entity = document.querySelector('[sound]');

                    entity.components.sound.playSound();

                    setTimeout(() => {
                        let target = document.getElementById(state.room);
                        let targetPos = target.getAttribute('position');

                        let newPos = { x: targetPos.x, y: targetPos.y, z: targetPos.z };

                        let playerElement = document.getElementById('player');

                        let moveAnimation = document.createElement('a-animation');
                        moveAnimation.setAttribute('attribute', 'position');
                        moveAnimation.setAttribute('dur', '2500');
                        moveAnimation.setAttribute('fill', 'forwards');

                        let targetDoor = document.getElementById(state.doorElementId);

                        let doorPosition = targetDoor.getAttribute('position');

                        // this is to not move the camera through the door

                        if (doorPosition.x > 0)
                            doorPosition.x = doorPosition.x - 0.20;

                        if (doorPosition.z > 0)
                            doorPosition.z = doorPosition.z - 0.20;

                        let animationEndPosition = doorPosition.x + ' ' + playerElement.getAttribute('position').y + ' ' + doorPosition.z;
                        moveAnimation.setAttribute('to', animationEndPosition);

                        // Set state instead?
                        // if (this.getAttribute('opened') === 'false') {
                        //     this.setAttribute('opened', 'true');
                        //     this.parentEl.parentEl.setAttribute('color', '#000000');
                        // }

                        // this.parentEl.setAttribute('color', '#000000');

                        playerElement.appendChild(moveAnimation);

                        setTimeout(() => {
                            playerElement.setAttribute('position', newPos);

                            let number = getRandomInt(0, 20);

                            if (number === 19) {
                                let samara = document.createElement('a-entity');
                                samara.setAttribute('id', 'samara');
                                samara.setAttribute('position', '3 3.5 3');

                                let avatar = document.createElement('a-image');
                                avatar.setAttribute('src', 'lol.png');
                                avatar.setAttribute('position', '0 0 0');

                                let sound = document.createElement('a-sound');
                                sound.setAttribute('src', 'lol.mp3');
                                sound.setAttribute('autoplay', 'true');
                                sound.setAttribute('loop', 'infinite');

                                let animation = document.createElement('a-animation');
                                animation.setAttribute('attribute', 'position');
                                animation.setAttribute('dur', '10000');
                                animation.setAttribute('fill', 'forwards');
                                animation.setAttribute('to', '0 3.5 0');

                                samara.appendChild(avatar);
                                samara.appendChild(sound);
                                samara.appendChild(animation);

                                let player = document.getElementById('player');

                                player.appendChild(samara);
                            }
                        }, 2550);
                    }, 1200);
                } else {
                    let enemyElement = document.getElementById(state.player);

                    let roomElement = document.getElementById(state.room);
                    enemyElement.setAttribute('position', roomElement.getAttribute('position'));
                }
            });
        });

        AFRAME.registerComponent('open-door', {
            init: function () {
                this.el.addEventListener('click', function (evt) {

                    let target = this.getAttribute('target');

                    let playerElement = document.getElementById('player');

                    socket.emit('player-move', { currentRoom: playerElement.getAttribute('currentroom'), targetRoom: target, player: playerName, doorElementId: this.getAttribute('id') });
                });
            }
        });

        AFRAME.registerComponent('open-inventory-listener', {
            init: function () {
                this.el.addEventListener('click', function (evt) {
                    let inventoryElement = document.createElement('a-plane');
                    inventoryElement.setAttribute('position', '0 2.6 0');
                    inventoryElement.setAttribute('rotation', '90 0 -90');
                    inventoryElement.setAttribute('id', 'inventory');

                    let exitElement = document.createElement('a-plane');
                    exitElement.setAttribute('value', 'X');
                    exitElement.setAttribute('position', '0 0.4 0.05');
                    exitElement.setAttribute('rotation', '0 0 -90');
                    exitElement.setAttribute('scale', '0.2 0.2 1');
                    exitElement.setAttribute('color', 'green');
                    exitElement.setAttribute('close-inventory-listener', '');

                    inventoryElement.appendChild(exitElement);

                    let playerElement = document.getElementById('player');
                    playerElement.appendChild(inventoryElement);
                });
            }
        });

        AFRAME.registerComponent('close-inventory-listener', {
            init: function () {
                this.el.addEventListener('click', function (evt) {
                    console.log('close inventory');
                    let inventoryElement = document.getElementById('inventory');

                    inventoryElement.parentNode.removeChild(inventoryElement);
                });
            }
        });

        AFRAME.registerComponent('game-timer', {
            init: () => {
                let time = 180;
                setInterval(() => {

                    time = time - 1;

                    let timeElement = document.getElementById('timer');

                    timeElement.setAttribute('value', time);
                }, 1000);
            }
        });
    </script>
</head>

<body>
    <a-scene id="scene">
        <a-assets>
            <audio id="door" src="door.mp3"></audio>
            <image id="spy" src="spy.jpeg">
                <image id="lol" src="lol.png">
        </a-assets>
        <a-sky color="gray"></a-sky>
        <a-entity motion-tracker id="player" position="0 -50 0">
            <a-camera look-controls wasd-controls position="0 1.83 0">
                <a-entity id="opendoor" sound="src: #door"></a-entity>
                <a-text id="timer" game-timer color="red" position="-2.6 -1.2 -1.5" scale="0.2 0.2 0.2"></a-text>
                <a-entity cursor="fuse: true; fuseTimeout: 500" position="0 0 -1" geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                    material="color: black; shader: flat">
                </a-entity>
            </a-camera>
        </a-entity>
    </a-scene>
    <script>
        // (() => {

        //     function GenerateRandomMap(rooms, options) {

        //         let template = {};

        //         if (options === null || options === undefined)
        //             options = { time: 180 };

        //         template.options = options;
        //         template.rooms = [];

        //         let directions = { 1: "N", 2: "S", 3: "E", 4: "W" };

        //         for (let i = 1; i < rooms + 1; i++) {
        //             let room = { "Id": i, "Directions": {} };

        //             let maxConnectingWalls = 0;

        //             if ((rooms - i) > 4) {
        //                 maxConnectingWalls = 4;
        //             } else if (rooms - i === 0) {
        //                 // TODO: unnecessary?
        //                 maxConnectingWalls = 0;
        //             } else {
        //                 maxConnectingWalls = rooms - i;
        //             }

        //             let connectingWalls = getRandomInt(1, maxConnectingWalls);

        //             for (let j = 0; j < connectingWalls; j++) {
        //                 let directionKey = getRandomInt(0, 4);
        //                 room.Directions[directions[directionKey]] = "?";
        //             }

        //             template.rooms.push(room);
        //         }

        //         template.rooms.forEach((room) => {

        //             for (let dir in room.Directions) {
        //                 let targetRoom = room.Directions[dir];

        //                 let found = template.rooms.filter((r) => { return r.Id === targetRoom });

        //                 if (found.length === 0 || targetRoom === '?') {
        //                     throw 'Room targets another room that does not exist!';
        //                 }
        //             }
        //         });

        //         return template;
        //     }

        //     // let template = {
        //     //     options: {
        //     //         time: '180'
        //     //     },
        //     //     rooms: [
        //     //         // { "Id": "1", "Directions": { "N": "2" }, "Colors": { "Floor": "#F5EBCD", "Wall": "#FFD79F" } }
        //     //         // ,
        //     //         // { "Id": "2", "Directions": { "S": "1", "W": "3" }, "Colors": { "Floor": "#BCC9E5", "Wall": "#A0B8FF" } }
        //     //         // ,
        //     //         // { "Id": "3", "Directions": { "E": "2", "W": "4" }, "Colors": { "Floor": "#DC9BBD", "Wall": "#FA74B3" } },
        //     //         // { "Id": "4", "Directions": { "N": "5", "E": "3" }, "Colors": { "Floor": "#DB9FC0", "Wall": "#F973B2" } },
        //     //         // { "Id": "5", "Directions": { "S": "4" }, "Colors": { "Floor": "#F2FBD0", "Wall": "#E4FCA4" } }
        //     //         { "Id": "1", "Directions": { "N": "2", "S": "3", "E": "4", "W": "5" }, "Colors": { "Floor": "#F5EBCD", "Wall": "#FFD79F" } }
        //     //         ,
        //     //         { "Id": "2", "Directions": { "W": "6", "E": "7", "S": "1" }, "Colors": { "Floor": "#BCC9E5", "Wall": "#A0B8FF" } }
        //     //         ,
        //     //         { "Id": "3", "Directions": { "N": "1", "W": "8", "E": "9" }, "Colors": { "Floor": "#DC9BBD", "Wall": "#FA74B3" } },
        //     //         { "Id": "4", "Directions": { "N": "7", "E": "1", "S": "9" }, "Colors": { "Floor": "#DB9FC0", "Wall": "#F973B2" } },
        //     //         { "Id": "5", "Directions": { "S": "8", "N": "6", "E": "1" }, "Colors": { "Floor": "#F2FBD0", "Wall": "#E4FCA4" } },
        //     //         { "Id": "6", "Directions": { "S": "5", "E": "2" }, "Colors": { "Floor": "#F2FBD0", "Wall": "#E4FCA4" } },
        //     //         { "Id": "7", "Directions": { "S": "4", "W": "2" }, "Colors": { "Floor": "#F2FBD0", "Wall": "#E4FCA4" } },
        //     //         { "Id": "8", "Directions": { "N": "5", "E": "3" }, "Colors": { "Floor": "#F2FBD0", "Wall": "#E4FCA4" } },
        //     //         { "Id": "9", "Directions": { "N": "4", "W": "3" }, "Colors": { "Floor": "#F2FBD0", "Wall": "#E4FCA4" } }
        //     //     ]
        //     // };
        // })();
    </script>
</body>

</html>